<div class="invoice-editor-container" *ngIf="!isLoading">

  <!-- Header Card -->
  <mat-card class="header-card">
    <mat-card-content>
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title">{{ getPageTitle() }}</h1>
        </div>
        <div class="header-actions">
          <button mat-stroked-button (click)="cancel()">
            <mat-icon>close</mat-icon>
            {{ 'COMMON.CANCEL' | translate }}
          </button>
          <button mat-raised-button
                  color="primary"
                  (click)="saveDraft()"
                  [disabled]="isSaving">
            <mat-icon>save</mat-icon>
            {{ 'COMMON.SAVE' | translate }}
          </button>
          <button mat-raised-button
                  color="accent"
                  (click)="saveAndFinalize()"
                  [disabled]="isSaving">
            <mat-icon>check_circle</mat-icon>
            {{ 'INVOICE.FINALIZE' | translate }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <form [formGroup]="invoiceForm" class="invoice-form">

    <!-- â”€â”€ Invoice Meta Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>description</mat-icon>
          {{ 'INVOICE.TITLE' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>

        <div class="form-row">
          <!-- Invoice Date -->
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>{{ 'INVOICE.DATE' | translate }}</mat-label>
            <input matInput type="date" formControlName="invoiceDate" required>
            <mat-icon matPrefix>calendar_today</mat-icon>
            <mat-error *ngIf="invoiceForm.get('invoiceDate')?.invalid">
              {{ 'MESSAGES.REQUIRED_FIELD' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Language -->
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>{{ 'INVOICE.LANGUAGE' | translate }}</mat-label>
            <mat-select formControlName="language" required>
              <mat-option value="de">ðŸ‡©ðŸ‡ª Deutsch</mat-option>
              <mat-option value="en">ðŸ‡¬ðŸ‡§ English</mat-option>
            </mat-select>
            <mat-icon matPrefix>language</mat-icon>
            <mat-error *ngIf="invoiceForm.get('language')?.invalid">
              {{ 'MESSAGES.REQUIRED_FIELD' | translate }}
            </mat-error>
          </mat-form-field>
        </div>

      </mat-card-content>
    </mat-card>

    <!-- â”€â”€ Customer Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person</mat-icon>
          {{ 'INVOICE.CUSTOMER_NAME' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>

        <div class="form-row">
          <!-- Customer Name (required) -->
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>{{ 'INVOICE.CUSTOMER_NAME' | translate }}</mat-label>
            <input matInput formControlName="customerName" required>
            <mat-icon matPrefix>person</mat-icon>
            <mat-error *ngIf="invoiceForm.get('customerName')?.invalid">
              {{ 'MESSAGES.REQUIRED_FIELD' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Email (optional) -->
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>{{ 'INVOICE.CUSTOMER_EMAIL' | translate }} ({{ 'COMMON.OPTIONAL' | translate }})</mat-label>
            <input matInput type="email" formControlName="customerEmail"
                   [placeholder]="'INVOICE.CUSTOMER_EMAIL' | translate">
            <mat-icon matPrefix>email</mat-icon>
            <mat-error *ngIf="invoiceForm.get('customerEmail')?.hasError('email')">
              {{ 'MESSAGES.INVALID_NUMBER' | translate }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Company section -->
        <div class="section-divider">
          <span class="section-label">{{ 'INVOICE.COMPANY_SECTION' | translate }}</span>
        </div>

        <!-- Company Name -->
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>{{ 'INVOICE.COMPANY_NAME' | translate }} ({{ 'COMMON.OPTIONAL' | translate }})</mat-label>
          <input matInput formControlName="companyName"
                 [placeholder]="'INVOICE.COMPANY_NAME' | translate">
          <mat-icon matPrefix>business</mat-icon>
        </mat-form-field>

        <div class="form-row">
          <!-- Company Address -->
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>{{ 'INVOICE.COMPANY_ADDRESS' | translate }}</mat-label>
            <input matInput formControlName="companyAddress"
                   [placeholder]="'INVOICE.COMPANY_ADDRESS' | translate">
            <mat-icon matPrefix>home</mat-icon>
          </mat-form-field>

          <!-- City / Country -->
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>{{ 'INVOICE.COMPANY_CITY_COUNTRY' | translate }}</mat-label>
            <input matInput formControlName="companyCityCountry"
                   [placeholder]="'INVOICE.COMPANY_CITY_COUNTRY' | translate">
            <mat-icon matPrefix>location_city</mat-icon>
          </mat-form-field>
        </div>

      </mat-card-content>
    </mat-card>

    <!-- â”€â”€ Tour Details Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>tour</mat-icon>
          {{ 'INVOICE.TOUR_DETAILS' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>

        <div class="form-row">
          <!-- Am â€“ Tour date & time -->
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>{{ 'INVOICE.TOUR_DATE' | translate }} ({{ 'COMMON.OPTIONAL' | translate }})</mat-label>
            <input matInput type="datetime-local" formControlName="tourDate">
            <mat-icon matPrefix>event</mat-icon>
          </mat-form-field>

          <!-- Pax -->
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>{{ 'INVOICE.PAX' | translate }} ({{ 'COMMON.OPTIONAL' | translate }})</mat-label>
            <input matInput type="number" min="1" formControlName="pax"
                   [placeholder]="'INVOICE.PAX' | translate">
            <mat-icon matPrefix>group</mat-icon>
            <mat-error *ngIf="invoiceForm.get('pax')?.hasError('min')">
              {{ 'MESSAGES.MIN_VALUE' | translate: { min: 1 } }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Guide -->
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>{{ 'INVOICE.GUIDE' | translate }} ({{ 'COMMON.OPTIONAL' | translate }})</mat-label>
          <input matInput formControlName="guide"
                 [placeholder]="'INVOICE.GUIDE' | translate">
          <mat-icon matPrefix>badge</mat-icon>
        </mat-form-field>

      </mat-card-content>
    </mat-card>

    <!-- â”€â”€ Line Items Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>list</mat-icon>
          {{ 'INVOICE.LINE_ITEMS' | translate }}
        </mat-card-title>
        <div class="header-actions-inline">
          <button mat-raised-button type="button" color="primary" (click)="openTourSelector()">
            <mat-icon>add</mat-icon>
            {{ 'INVOICE.ADD_FROM_TOUR' | translate }}
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>

        <app-line-items-table
          [lineItems]="lineItems"
          (lineItemsChange)="onLineItemsUpdate($event)">
        </app-line-items-table>

        <div class="empty-line-items" *ngIf="lineItems.length === 0">
          <mat-icon class="empty-icon">shopping_cart</mat-icon>
          <p>{{ 'INVOICE.ADD_LINE_ITEM' | translate }}</p>
          <button mat-raised-button type="button" color="primary" (click)="openTourSelector()">
            <mat-icon>add</mat-icon>
            {{ 'INVOICE.ADD_FROM_TOUR' | translate }}
          </button>
        </div>

      </mat-card-content>
    </mat-card>

    <!-- â”€â”€ VAT Summary Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <mat-card *ngIf="lineItems.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>calculate</mat-icon>
          {{ 'INVOICE.GRAND_TOTAL' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <app-vat-summary
          [lineItems]="lineItems"
          [language]="invoiceForm.get('language')?.value">
        </app-vat-summary>
      </mat-card-content>
    </mat-card>

    <!-- â”€â”€ Bottom Action Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="action-buttons">
      <button mat-stroked-button type="button" (click)="cancel()">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
      <button mat-raised-button type="button" color="primary"
              (click)="saveDraft()" [disabled]="isSaving">
        <mat-icon>save</mat-icon>
        {{ 'COMMON.SAVE' | translate }}
      </button>
      <button mat-raised-button type="button" color="accent"
              (click)="saveAndFinalize()" [disabled]="isSaving">
        <mat-icon>check_circle</mat-icon>
        {{ 'INVOICE.FINALIZE' | translate }}
      </button>
    </div>

  </form>

  <!-- Saving overlay -->
  <div class="loading-overlay" *ngIf="isSaving">
    <mat-spinner></mat-spinner>
  </div>

</div>

<!-- Initial loading -->
<div class="initial-loading" *ngIf="isLoading">
  <mat-spinner></mat-spinner>
  <p>{{ 'COMMON.LOADING' | translate }}...</p>
</div>